<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∑–∞–∫–ª–∞–¥–∫–∏ ‚Äî MVP</title>
    <style>
        :root{
            --brand: hsl(212 85% 52%);
            --bg: hsl(210 40% 98%);
            --card: #fff;
            --text: hsl(222 47% 11%);
            --muted: hsl(215 16% 47%);
            --accent: hsl(28 90% 55%);
            --danger: hsl(0 72% 55%);
            --radius: 14px;
        }
        body.dark{
            --bg: hsl(220 18% 10%);
            --card: hsl(222 23% 16%);
            --text: hsl(210 20% 96%);
            --muted: hsl(215 14% 72%);
            --brand: hsl(212 90% 62%);
            --accent: hsl(28 95% 60%);
            --danger: hsl(0 80% 60%);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:var(--text);background:var(--bg)}

        header{position:sticky;top:0;background:var(--card);border-bottom:1px solid #e9eef3;z-index:5}
        body.dark header{border-color:#2a3340}
        .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
        .title{display:flex;gap:12px;align-items:center;justify-content:space-between}
        h1{font-size:20px;margin:0}
        .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        input[type="text"], input[type="number"], textarea{width:100%;border:1px solid #e1e7ee;border-radius:10px;padding:10px 12px;font:inherit;background:#fff;color:#0f1b2d}
        body.dark input[type="text"], body.dark input[type="number"], body.dark textarea{background:#111826;color:#eaf0f8;border-color:#2a3340}
        textarea{min-height:90px}
        button{border:0;border-radius:10px;padding:10px 12px;font:inherit;cursor:pointer;background:var(--brand);color:#fff}
        button.ghost{background:#eef4fb;color:#0f1b2d}
        body.dark button.ghost{background:#1b2430;color:#eaf0f8;border:1px solid #2a3340}
        button.danger{background:var(--danger)}
        button.secondary{background:var(--accent)}
        button:disabled{opacity:.6;cursor:not-allowed}
        select{border:1px solid #e1e7ee;border-radius:10px;padding:10px 12px;background:#fff}
        body.dark select{background:#111826;color:#eaf0f8;border-color:#2a3340}

        /* –ì–æ–ª–æ–≤–Ω–∏–π –≥—Ä—ñ–¥: –ö–Ω–∏–≥–∏ | –ì–æ–ª–æ–≤–Ω–∞ | –ü–æ—à—É–∫ */
        .layout{display:grid;grid-template-columns:300px 1fr 300px;gap:16px;max-width:1200px;margin:18px auto;padding:0 18px}

        .card{background:var(--card);border:1px solid #e9eef3;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
        body.dark .card{border-color:#2a3340;box-shadow:none}
        .card .hd{padding:12px 14px;border-bottom:1px solid #eef2f6;display:flex;align-items:center;justify-content:space-between;gap:8px}
        body.dark .card .hd{border-color:#2a3340}
        .card .bd{padding:14px}

        /* Sidebar */
        .panel-scroll{height:calc(100dvh - 140px);overflow:auto}
        .book-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer}
        .book-item:hover{background:#f3f7fb}
        body.dark .book-item:hover{background:#1b2430}
        .book-item.active{background:#eaf2ff;border:1px solid #d6e7ff}
        body.dark .book-item.active{background:#16202b;border-color:#2a3340}
        .book-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .book-actions{display:flex;gap:6px}

        /* Main */
        .stack{display:grid;gap:10px}
        .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .notes{display:grid;gap:10px}
        .note{border:1px solid #e9eef3;border-radius:12px;padding:10px}
        body.dark .note{border-color:#2a3340}
        .note .top{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .muted{color:var(--muted);font-size:13px}

        /* Search results */
        .results{display:grid;gap:10px}
        .result{padding:10px;border:1px dashed #e1e7ee;border-radius:12px;background:#fff}
        body.dark .result{background:#0f1520;border-color:#2a3340}
        .result b{background:#fff2c6}

        /* –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ label –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ */
        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

        @media (max-width:900px){
            .layout{grid-template-columns:1fr}
            .panel-scroll{height:auto}
        }
    </style>
</head>
<body>
<header>
    <div class="wrap title">
        <h1>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∑–∞–∫–ª–∞–¥–∫–∏</h1>
        <div class="toolbar" style="flex:1;justify-content:flex-end">
            <label class="sr-only" for="q">–ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫</label>
            <input id="q" type="text" placeholder="–ü–æ—à—É–∫ —É –≤—Å—ñ—Ö –∫–Ω–∏–≥–∞—Ö‚Ä¶" style="max-width:360px" />
            <button id="searchBtn" class="ghost" title="–ü–æ—à—É–∫ [Enter]">–ü–æ—à—É–∫</button>
            <button id="exportBtn" class="ghost" title="–ï–∫—Å–ø–æ—Ä—Ç —É JSON">–ï–∫—Å–ø–æ—Ä—Ç</button>
            <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
                <input id="importFile" type="file" accept="application/json" hidden />
                <span class="btn-like" style="padding:10px 12px;border:1px solid #e1e7ee;border-radius:10px;background:#fff">–Ü–º–ø–æ—Ä—Ç</span>
            </label>
            <button id="themeBtn" class="ghost" title="–¢–µ–º–Ω–∞/—Å–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞">üåì</button>
        </div>
    </div>
</header>

<main class="layout">
    <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å: –ö–Ω–∏–≥–∏ -->
    <section class="card">
        <div class="hd">
            <strong>–ö–Ω–∏–≥–∏</strong>
            <button id="addBookBtn" class="secondary">–ù–æ–≤–∞ –∫–Ω–∏–≥–∞</button>
        </div>
        <div class="bd panel-scroll" id="books"></div>
    </section>

    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å: –ø–æ—Ç–æ—á–Ω–∞ –∫–Ω–∏–≥–∞ -->
    <section class="card">
        <div class="hd" style="gap:14px">
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                <strong id="currentBookTitle">–í–∏–±–µ—Ä—ñ—Ç—å –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –∫–Ω–∏–≥—É</strong>
                <span class="muted" id="noteCount"></span>
            </div>
            <div class="row">
                <label class="sr-only" for="bookFilter">–§—ñ–ª—å—Ç—Ä —É –ø–æ—Ç–æ—á–Ω—ñ–π –∫–Ω–∏–∑—ñ</label>
                <input id="bookFilter" type="text" placeholder="–§—ñ–ª—å—Ç—Ä —É –ø–æ—Ç–æ—á–Ω—ñ–π –∫–Ω–∏–∑—ñ‚Ä¶" style="max-width:240px" />
                <select id="sortNotes" title="–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è">
                    <option value="page-asc">–°—Ç–æ—Ä—ñ–Ω–∫–∞ ‚Üë</option>
                    <option value="page-desc">–°—Ç–æ—Ä—ñ–Ω–∫–∞ ‚Üì</option>
                    <option value="newest">–ù–æ–≤—ñ—à—ñ</option>
                    <option value="oldest">–°—Ç–∞—Ä—ñ—à—ñ</option>
                </select>
                <button id="deleteBookBtn" class="danger" title="–í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–∏–≥—É –∑ —É—Å—ñ–º–∞ –∑–∞–∫–ª–∞–¥–∫–∞–º–∏" disabled>–í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–∏–≥—É</button>
            </div>
        </div>
        <div class="bd">
            <div id="tagFilterWrap" class="row" style="display:none"></div>

            <div id="addNoteForm" class="stack" style="display:none">
                <div class="row">
                    <label class="sr-only" for="page">–°—Ç–æ—Ä—ñ–Ω–∫–∞</label>
                    <input id="page" type="number" min="1" step="1" placeholder="–°—Ç–æ—Ä—ñ–Ω–∫–∞" style="max-width:120px" />
                    <button id="nextPageBtn" class="ghost" title="–ù–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞">+1</button>

                    <label class="sr-only" for="summary">–ö–æ—Ä–æ—Ç–∫–∏–π –∑–º—ñ—Å—Ç</label>
                    <input id="summary" type="text" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –∑–º—ñ—Å—Ç/—Ç–µ–∑–∞" />

                    <button id="addNoteBtn">–î–æ–¥–∞—Ç–∏ –∑–∞–∫–ª–∞–¥–∫—É</button>
                </div>
                <label class="sr-only" for="fullText">–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç</label>
                <textarea id="fullText" placeholder="–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
            </div>

            <div class="notes" id="notes"></div>
            <div id="emptyState" class="muted">–ó–∞–∫–ª–∞–¥–æ–∫ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</div>
        </div>
    </section>

    <!-- –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å: —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É -->
    <section class="card">
        <div class="hd">
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É</strong>
            <span class="muted" id="resCount"></span>
        </div>
        <div class="bd panel-scroll">
            <div class="results" id="results"></div>
            <div id="noResults" class="muted">–¢—É—Ç –∑'—è–≤–ª—è—Ç—å—Å—è –∑–±—ñ–≥–∏ –∑–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º.</div>
        </div>
    </section>
</main>

<footer class="wrap" style="color:var(--muted);font-size:13px;margin-bottom:24px">
    –õ–æ–∫–∞–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è. –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É <code>localStorage</code> –≤–∞—à–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞. –ï–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ JSON –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–∏—Ö –∫–æ–ø—ñ–π.
</footer>

<script>
    (function(){
        "use strict";

        // ---- Storage & state ----
        const KEY = "eBookmarks-MVP:v1";
        const uid = () => "id-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
        const load = () => { try { return JSON.parse(localStorage.getItem(KEY)) || { books: [], prefs:{theme:"light", sort:"page-asc"} }; } catch { return { books: [], prefs:{theme:"light", sort:"page-asc"} }; } };
        const save = (s) => localStorage.setItem(KEY, JSON.stringify(s));
        let state = load();
        let currentBookId = state.books[0]?.id || null;
        let selectedTags = new Set();

        // ---- Theme ----
        function applyTheme(){ document.body.classList.toggle("dark", state.prefs?.theme==="dark"); }
        applyTheme();

        // ---- DOM refs ----
        const booksEl   = document.getElementById("books");
        const titleEl   = document.getElementById("currentBookTitle");
        const noteCountEl = document.getElementById("noteCount");
        const addNoteForm = document.getElementById("addNoteForm");
        const notesEl   = document.getElementById("notes");
        const emptyEl   = document.getElementById("emptyState");
        const delBtn    = document.getElementById("deleteBookBtn");
        const tagFilterWrap = document.getElementById("tagFilterWrap");

        const addBookBtn   = document.getElementById("addBookBtn");
        const addNoteBtn   = document.getElementById("addNoteBtn");
        const pageInput    = document.getElementById("page");
        const summaryInput = document.getElementById("summary");
        const fullTextInput= document.getElementById("fullText");
        const nextPageBtn  = document.getElementById("nextPageBtn");

        const bookFilterEl = document.getElementById("bookFilter");
        const sortNotesEl  = document.getElementById("sortNotes");

        const qEl          = document.getElementById("q");
        const searchBtn    = document.getElementById("searchBtn");
        const resultsEl    = document.getElementById("results");
        const resCountEl   = document.getElementById("resCount");
        const noResultsEl  = document.getElementById("noResults");

        // ---- Utils ----
        function escapeHtml(str){
            const div = document.createElement("div");
            div.textContent = String(str ?? "");
            return div.innerHTML;
        }
        function currentBook(){ return state.books.find(b=>b.id===currentBookId) || null; }
        function saveState(){ save(state); }
        function bookUniqueTags(b){
            const set = new Set();
            (b.notes||[]).forEach(n => (n.tags||[]).forEach(t => set.add(t)));
            return Array.from(set).sort((a,b)=> a.localeCompare(b));
        }
        function normalize(s){ return (s || "").toLocaleLowerCase(); }

        // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –±–µ–∑ regex
        function highlightPlain(text, query){
            if(!query) return escapeHtml(text || "");
            const src = String(text || "");
            const q = query.toLocaleLowerCase();
            if(!q) return escapeHtml(src);
            const hay = src.toLocaleLowerCase();
            let i = 0, out = "";
            let idx = hay.indexOf(q, i);
            while(idx !== -1){
                out += escapeHtml(src.slice(i, idx));
                out += "<b>" + escapeHtml(src.slice(idx, idx + q.length)) + "</b>";
                i = idx + q.length;
                idx = hay.indexOf(q, i);
            }
            out += escapeHtml(src.slice(i));
            return out;
        }

        // ---- Books list ----
        function renderBooks(){
            booksEl.innerHTML = "";
            if(state.books.length===0){
                booksEl.innerHTML = '<div class="muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∫–Ω–∏–≥. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É.</div>';
                currentBookId = null;
                updateMain();
                return;
            }
            state.books.forEach((b)=>{
                const item = document.createElement("div");
                item.className = "book-item" + (b.id===currentBookId ? " active" : "");
                item.innerHTML =
                    '<div class="book-title" title="'+escapeHtml(b.title)+'">'+escapeHtml(b.title)+'</div>' +
                    '<div class="book-actions">' +
                    '  <button class="ghost" data-act="rename" title="–ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏">‚úé</button>' +
                    '  <button class="ghost danger" data-act="remove" title="–í–∏–¥–∞–ª–∏—Ç–∏">‚úï</button>' +
                    '</div>';

                item.addEventListener("click",(e)=>{
                    if(!e.target.dataset.act){ currentBookId = b.id; selectedTags.clear(); renderBooks(); updateMain(); }
                });
                item.querySelector('[data-act="rename"]').addEventListener("click",(e)=>{
                    e.stopPropagation();
                    const name = prompt("–ù–æ–≤–∞ –Ω–∞–∑–≤–∞ –∫–Ω–∏–≥–∏:", b.title);
                    if(name && name.trim()){ b.title = name.trim(); saveState(); renderBooks(); updateMain(); }
                });
                item.querySelector('[data-act="remove"]').addEventListener("click",(e)=>{
                    e.stopPropagation();
                    if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–∏–≥—É –∑ —É—Å—ñ–º–∞ –∑–∞–∫–ª–∞–¥–∫–∞–º–∏?")){
                        state.books = state.books.filter(x=>x.id!==b.id);
                        if(currentBookId===b.id){ currentBookId = state.books[0]?.id || null; }
                        saveState(); renderBooks(); updateMain();
                    }
                });

                booksEl.appendChild(item);
            });
        }

        // ---- Tags filter (—Å—Ö–æ–≤–∞—î—Ç—å—Å—è —è–∫—â–æ —Ç–µ–≥—ñ–≤ –Ω–µ–º–∞) ----
        function renderTagFilter(b){
            const tags = bookUniqueTags(b);
            tagFilterWrap.innerHTML = "";
            if(tags.length===0){ tagFilterWrap.style.display="none"; return; }
            tagFilterWrap.style.display="flex";
            const clearBtn = document.createElement("button");
            clearBtn.className = "ghost";
            clearBtn.textContent = "–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä";
            clearBtn.addEventListener("click", ()=>{ selectedTags.clear(); updateMain(); });
            tagFilterWrap.appendChild(clearBtn);
            tags.forEach(t=>{
                const chip = document.createElement("span");
                const active = selectedTags.has(t);
                chip.className = "chip";
                chip.style.outline = active ? "2px solid var(--accent)" : "none";
                chip.innerHTML = escapeHtml(t);
                chip.addEventListener("click", ()=>{ active ? selectedTags.delete(t) : selectedTags.add(t); updateMain(); });
                tagFilterWrap.appendChild(chip);
            });
        }

        // ---- Main (notes) ----
        function updateMain(){
            const b = currentBook();
            if(!b){
                titleEl.textContent = "–í–∏–±–µ—Ä—ñ—Ç—å –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –∫–Ω–∏–≥—É";
                noteCountEl.textContent = "";
                addNoteForm.style.display = "none";
                delBtn.disabled = true;
                notesEl.innerHTML = "";
                tagFilterWrap.style.display = "none";
                emptyEl.style.display = "block";
                return;
            }
            titleEl.textContent = b.title;
            noteCountEl.textContent = (b.notes && b.notes.length) ? ("‚Ä¢ " + String(b.notes.length) + " –∑–∞–∫–ª–∞–¥–æ–∫") : "";
            addNoteForm.style.display = "grid";
            delBtn.disabled = false;

            renderTagFilter(b);

            const q = (bookFilterEl.value || "").toLocaleLowerCase().trim();
            const byTags = selectedTags;
            const sort = state.prefs?.sort || "page-asc";

            let notes = (b.notes || []).slice();
            if(q){
                notes = notes.filter(n=>{
                    const hay = (n.summary||"").toLocaleLowerCase() + "\n" + (n.fullText||"").toLocaleLowerCase();
                    return hay.indexOf(q) !== -1;
                });
            }
            if(byTags.size){
                notes = notes.filter(n => (n.tags||[]).some(t => byTags.has(t)));
            }
            notes.sort((a,c)=>{
                if(sort==="page-asc")  return a.page - c.page;
                if(sort==="page-desc") return c.page - a.page;
                if(sort==="newest")    return new Date(c.createdAt) - new Date(a.createdAt);
                if(sort==="oldest")    return new Date(a.createdAt) - new Date(c.createdAt);
                return a.page - c.page;
            });

            notesEl.innerHTML = "";
            emptyEl.style.display = notes.length ? "none" : "block";

            notes.forEach(n=>{
                const el = document.createElement("div");
                el.className = "note";
                const tagsHtml = (n.tags||[]).map(t => '<span class="chip" title="–¢–µ–≥">'+escapeHtml(t)+'</span>').join(" ");
                el.innerHTML =
                    '<div class="top">' +
                    '  <div><strong>–°—Ç–æ—Ä. ' + n.page + '</strong> <span class="muted">‚Ä¢ ' + new Date(n.createdAt).toLocaleString() + '</span></div>' +
                    '  <div class="row">' +
                    '    <button class="ghost" data-act="edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>' +
                    '    <button class="ghost danger" data-act="del">–í–∏–¥–∞–ª–∏—Ç–∏</button>' +
                    '  </div>' +
                    '</div>' +
                    '<div class="muted" style="margin-top:6px">' + escapeHtml(n.summary || "") + '</div>' +
                    (n.fullText ? ('<details style="margin-top:6px"><summary>–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç</summary><div style="margin-top:6px">' + escapeHtml(n.fullText) + '</div></details>') : '') +
                    (tagsHtml ? ('<div class="row" style="margin-top:8px">'+tagsHtml+'</div>') : '');

                el.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
                    const page = parseInt(prompt("–ù–æ–º–µ—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏:", n.page), 10);
                    const summary = (prompt("–ö–æ—Ä–æ—Ç–∫–∏–π –∑–º—ñ—Å—Ç:", n.summary||"") ?? n.summary);
                    const full = (prompt("–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):", n.fullText||"") ?? n.fullText);
                    if(!Number.isFinite(page) || page < 1){ alert("–°—Ç–æ—Ä—ñ–Ω–∫–∞ –º–∞—î –±—É—Ç–∏ —Ü—ñ–ª–∏–º —á–∏—Å–ª–æ–º ‚â• 1"); return; }
                    n.page = Math.floor(page);
                    n.summary = (summary||"").trim();
                    n.fullText = (full||"").trim();
                    saveState(); updateMain();
                });

                el.querySelector('[data-act="del"]').addEventListener("click", ()=>{
                    if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–∞–∫–ª–∞–¥–∫—É?")){
                        b.notes = (b.notes||[]).filter(x=>x.id!==n.id);
                        saveState(); updateMain();
                    }
                });

                notesEl.appendChild(el);
            });
        }

        // ---- Global search ----
        function searchGlobal(){
            const query = (qEl && qEl.value ? qEl.value : "").trim();

            resultsEl.innerHTML = "";
            resCountEl.textContent = "";
            if(!query){
                noResultsEl.style.display = "block";
                return;
            }
            noResultsEl.style.display = "none";

            const qn = query.toLocaleLowerCase();
            const matches = [];

            for (const b of (state.books || [])) {
                for (const n of (b.notes || [])) {
                    const fields = [ b.title || "", n.summary || "", n.fullText || "", ...(n.tags || []) ];
                    const hay = fields.join("\n").toLocaleLowerCase();
                    if (hay.indexOf(qn) !== -1) {
                        matches.push({ bookId: b.id, bookTitle: b.title || "", page: n.page, summary: n.summary || "", fullText: n.fullText || "", createdAt: n.createdAt });
                    }
                }
            }

            matches.sort((a,b)=>{
                const byTitle = a.bookTitle.localeCompare(b.bookTitle);
                if(byTitle!==0) return byTitle;
                if(a.page!==b.page) return a.page - b.page;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            if(matches.length === 0){
                resCountEl.textContent = "–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
                noResultsEl.style.display = "block";
                return;
            }
            resCountEl.textContent = String(matches.length) + " –∑–±—ñ–≥(—ñ–≤)";

            for (const m of matches) {
                const el = document.createElement("div");
                el.className = "result";
                const snippet = m.fullText || m.summary || "";
                el.innerHTML =
                    '<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">' +
                    '  <div><strong>'+escapeHtml(m.bookTitle)+'</strong> <span class="muted">‚Ä¢ —Å—Ç–æ—Ä. '+m.page+'</span></div>' +
                    '  <button class="ghost" data-act="go">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–Ω–∏–≥–∏</button>' +
                    '</div>' +
                    '<div class="muted" style="margin-top:6px">' +
                    (snippet ? highlightPlain(snippet, query) : '<i>–ë–µ–∑ —Ç–µ–∫—Å—Ç—É</i>') +
                    '</div>';

                el.querySelector('[data-act="go"]').addEventListener("click", ()=>{
                    currentBookId = m.bookId; renderBooks(); updateMain();
                    const children = Array.prototype.slice.call(notesEl.children);
                    const target = children.find(ch=>{
                        const t = ch.querySelector(".top");
                        return t && t.textContent && t.textContent.indexOf("–°—Ç–æ—Ä. "+m.page)!==-1;
                    });
                    if(target){
                        target.scrollIntoView({ behavior:"smooth", block:"center" });
                        target.style.outline = "2px solid var(--accent)";
                        setTimeout(()=>{ target.style.outline = "none"; }, 1500);
                    }
                });

                resultsEl.appendChild(el);
            }
        }

        // ---- Actions ----
        document.getElementById("exportBtn").addEventListener("click", ()=>{
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "ebookmarks.json"; a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById("importFile").addEventListener("change", async (e)=>{
            const f = e.target.files[0]; if(!f) return;
            try{
                const text = await f.text();
                const json = JSON.parse(text);
                if(!json || !Array.isArray(json.books)){
                    alert("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç");
                    e.target.value = "";
                    return;
                }
                state = json;
                state.prefs = state.prefs || { theme:"light", sort:"page-asc" };
                currentBookId = state.books[0]?.id || null;
                selectedTags.clear();
                saveState(); renderBooks(); updateMain(); applyTheme();
                alert("–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            }catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: " + err.message); }
            e.target.value = "";
        });

        document.getElementById("themeBtn").addEventListener("click", ()=>{
            state.prefs = state.prefs || {};
            state.prefs.theme = state.prefs.theme === "dark" ? "light" : "dark";
            saveState(); applyTheme();
        });

        document.getElementById("addBookBtn").addEventListener("click", ()=>{
            const title = prompt("–ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏:");
            if(!title || !title.trim()) return;
            const book = { id: uid(), title: title.trim(), createdAt: new Date().toISOString(), notes: [] };
            state.books.push(book);
            currentBookId = book.id;
            selectedTags.clear();
            saveState(); renderBooks(); updateMain();
        });

        document.getElementById("addNoteBtn").addEventListener("click", ()=>{
            const b = currentBook(); if(!b) return;
            const page = parseInt(pageInput.value, 10);
            if(!Number.isFinite(page) || page < 1){ alert("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (—Ü—ñ–ª–µ —á–∏—Å–ª–æ ‚â• 1)."); return; }
            const summary  = summaryInput.value.trim();
            const fullText = fullTextInput.value.trim();

            b.notes = b.notes || [];
            b.notes.push({ id: uid(), page, summary, fullText, createdAt: new Date().toISOString() });

            pageInput.value = ""; summaryInput.value = ""; fullTextInput.value = "";
            saveState(); updateMain();
        });

        document.getElementById("deleteBookBtn").addEventListener("click", ()=>{
            const b = currentBook(); if(!b) return;
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–∏–≥—É —Ç–∞ –≤—Å—ñ —ó—ó –∑–∞–∫–ª–∞–¥–∫–∏?")){
                state.books = state.books.filter(x=>x.id!==b.id);
                currentBookId = state.books[0]?.id || null;
                selectedTags.clear();
                saveState(); renderBooks(); updateMain();
            }
        });

        document.getElementById("nextPageBtn").addEventListener("click", ()=>{
            const b = currentBook(); if(!b) return;
            let last = 0;
            (b.notes||[]).forEach(n => { if(n.page > last) last = n.page; });
            pageInput.value = String((last||0) + 1);
            summaryInput.focus();
        });

        bookFilterEl.addEventListener("input", updateMain);
        sortNotesEl.addEventListener("change", (e)=>{ state.prefs.sort = e.target.value; saveState(); updateMain(); });

        qEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") searchGlobal(); });
        searchBtn.addEventListener("click", searchGlobal);

        // ---- Init ----
        renderBooks();
        updateMain();
    })();
</script>
</body>
</html>
